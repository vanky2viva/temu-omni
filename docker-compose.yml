services:
  # PostgreSQL数据库
  postgres:
    image: postgres:13-alpine
    container_name: temu-omni-postgres
    environment:
      POSTGRES_DB: temu_omni
      POSTGRES_USER: temu_user
      POSTGRES_PASSWORD: temu_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U temu_user -d temu_omni"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - temu-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: temu-omni-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - temu-network

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: temu-omni-backend
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=Temu-Omni
      - APP_VERSION=1.0.0
      - DEBUG=True
      - SECRET_KEY=dev-secret-key-change-in-production
      - DATABASE_URL=postgresql://temu_user:temu_password@postgres:5432/temu_omni
      - REDIS_URL=redis://redis:6379/0
      - TEMU_APP_KEY=${TEMU_APP_KEY:-your_app_key}
      - TEMU_APP_SECRET=${TEMU_APP_SECRET:-your_app_secret}
      - TEMU_API_BASE_URL=https://agentpartner.temu.com/api
      - TEMU_API_PROXY_URL=${TEMU_API_PROXY_URL:-http://172.236.231.45:8001}
      - TEMU_CN_APP_KEY=${TEMU_CN_APP_KEY:-}
      - TEMU_CN_APP_SECRET=${TEMU_CN_APP_SECRET:-}
      - CORS_ORIGINS=["http://localhost:8001","http://localhost:3000","http://localhost:5173"]
      - AUTO_SYNC_ENABLED=False
      - SYNC_INTERVAL_MINUTES=30
      - TIMEZONE=Asia/Shanghai
    volumes:
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - temu-network
    restart: unless-stopped

  # Temu API 代理服务器（可选，如果代理服务器在本地运行）
  # 如果代理服务器在远程服务器运行，请确保 TEMU_API_PROXY_URL 指向正确的地址
  # temu-api-proxy:
  #   build:
  #     context: ./proxy-server
  #     dockerfile: Dockerfile
  #   container_name: temu-api-proxy
  #   ports:
  #     - "8001:8001"
  #   environment:
  #     - TEMU_APP_KEY=${TEMU_APP_KEY:-your_app_key}
  #     - TEMU_APP_SECRET=${TEMU_APP_SECRET:-your_app_secret}
  #   networks:
  #     - temu-network
  #   restart: unless-stopped

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: temu-omni-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_BASE_URL=http://localhost:8000
      - DOCKER_ENV=true
    depends_on:
      - backend
    networks:
      - temu-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  temu-network:
    driver: bridge

