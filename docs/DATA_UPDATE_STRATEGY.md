# 数据更新策略说明

## 📊 当前数据更新机制

### 1. 图表、销售数据、回款统计

**更新方式：**
- ✅ **每次访问页面时**：从数据库实时查询最新数据
- ✅ **自动刷新**：Dashboard 页面每 5 分钟自动刷新一次
- ✅ **手动刷新**：提供手动刷新按钮，可随时更新数据

**实现细节：**
- 前端使用 React Query 的 `refetchInterval` 实现自动轮询
- 后端 API 直接从数据库查询，无缓存，确保数据实时性
- 所有统计数据都是基于数据库当前状态计算

### 2. 订单成本计算

**更新方式：**
- ✅ **定时任务**：每 30 分钟自动计算一次（只更新没有成本的订单）
- ✅ **手动触发**：可通过 API 或脚本手动触发计算

**实现细节：**
- 使用 APScheduler 定时任务调度器
- 任务在应用启动时自动启动
- 只处理没有成本信息的订单，避免重复计算

## 🔄 数据更新流程

### 前端自动刷新流程

```
用户访问 Dashboard 页面
    ↓
React Query 自动获取数据
    ↓
每 5 分钟自动刷新（refetchInterval）
    ↓
调用后端 API 获取最新数据
    ↓
更新页面显示
```

### 后端定时任务流程

```
应用启动
    ↓
启动 APScheduler 调度器
    ↓
每 30 分钟执行一次
    ↓
查询没有成本的订单
    ↓
匹配商品信息
    ↓
计算成本和利润
    ↓
更新数据库
```

## ⚙️ 配置说明

### 前端刷新间隔

在 `frontend/src/pages/Dashboard.tsx` 中配置：

```typescript
const REFRESH_INTERVAL = 5 * 60 * 1000 // 5分钟（可调整）
```

### 后端定时任务间隔

在 `backend/app/core/scheduler.py` 中配置：

```python
# 每30分钟执行一次订单成本更新
scheduler.add_job(
    update_order_costs_job,
    trigger=IntervalTrigger(minutes=30),  # 可调整间隔
    ...
)
```

## 🛠️ 手动操作

### 手动刷新前端数据

1. 在 Dashboard 页面点击右上角的"手动刷新"按钮
2. 或刷新浏览器页面

### 手动触发订单成本计算

**方式1：通过 API**

```bash
POST /api/order-costs/calculate
{
  "shop_id": null,  # null 表示所有店铺
  "order_ids": null,  # null 表示所有订单
  "force_recalculate": false  # true 表示强制重新计算
}
```

**方式2：通过脚本**

```bash
cd backend
python scripts/update_order_costs.py [shop_id]
```

## 📝 注意事项

1. **数据实时性**：
   - 图表和统计数据：每次访问时实时查询，每 5 分钟自动刷新
   - 订单成本：每 30 分钟自动计算一次，新订单会在下次定时任务时计算

2. **性能考虑**：
   - 定时任务只处理没有成本的订单，避免重复计算
   - 前端自动刷新间隔可根据实际需求调整

3. **定时任务状态**：
   - 定时任务在应用启动时自动启动
   - 应用关闭时自动停止
   - 可通过日志查看任务执行情况

## 🔍 日志查看

### 前端刷新日志

在浏览器控制台可以看到数据刷新日志。

### 后端定时任务日志

查看应用日志，可以看到类似以下信息：

```
开始执行定时任务：更新订单成本...
订单成本更新完成 - 总计: 100, 成功: 95, 失败: 0, 跳过: 5
```

## 🚀 未来优化建议

1. **WebSocket 实时推送**：对于需要更高实时性的场景，可以考虑使用 WebSocket
2. **增量更新**：对于大数据量，可以考虑增量更新策略
3. **缓存机制**：对于不经常变化的数据，可以添加缓存层
4. **任务监控**：添加定时任务执行状态监控和告警

