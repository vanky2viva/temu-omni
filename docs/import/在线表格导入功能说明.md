# 在线表格导入功能说明

## 🎯 功能概述

除了支持Excel文件上传外，系统现已支持从**飞书在线表格**直接导入数据，无需下载文件！

### 优势对比

| 特性 | Excel文件 | 在线表格 |
|-----|---------|---------|
| **使用便捷度** | 需下载→上传 | 复制链接即可 ✅ |
| **数据实时性** | 需重新下载上传 | 实时同步 ✅ |
| **团队协作** | 不支持 | 多人协同编辑 ✅ |
| **历史版本** | 需手动管理 | 自动版本控制 ✅ |
| **数据验证** | 离线验证 | 在线规则验证 ✅ |

## 📋 支持的在线表格

目前支持：
- ✅ 飞书表格（Feishu/Lark Sheets）
- 📋 后续计划支持：腾讯文档、石墨文档、Google Sheets

## 🚀 使用方法

### 1. 准备飞书表格

#### 示例表格
您提供的表格链接：
```
https://mcnkufobiqbi.feishu.cn/sheets/Xd3SsrVlEhNoBXtawvlcryWVnJc?sheet=HPLHTM
```

#### 表格格式要求
- **列名必须与Temu导出格式一致**
- **第一行为列名，第二行开始为数据**
- **表格设置为「可访问」权限**

#### 活动数据表格列
- 商品信息
- SPU ID
- 活动站点
- 活动销量
- 活动 GMV
- 活动商品曝光用户数
- 活动商品点击用户数
- 活动商品点击转化率
- 活动商品支付转化率

#### 商品数据表格列
- 商品名称
- SKU ID
- SPU ID
- 申报价格
- 类目
- 状态
- SKU货号

### 2. 设置表格权限

在飞书表格中：
1. 点击右上角「分享」按钮
2. 选择「获取链接」
3. 设置权限为「知道链接的人可以查看」
4. 复制链接

### 3. 在系统中导入

1. 进入店铺管理页面
2. 点击需要导入数据的店铺的「导入」按钮
3. 选择数据类型（活动数据/商品数据）
4. 点击「在线表格」按钮
5. 粘贴飞书表格链接
6. 点击「开始导入」

## 💻 技术实现

### 后端架构

#### 新增文件
1. **backend/app/services/feishu_sheets_service.py** （272行）
   - 飞书表格API集成
   - URL解析和验证
   - 在线数据读取
   - 支持公开分享链接

#### 核心功能
```python
class FeishuSheetsService:
    - parse_feishu_url(url)        # 解析表格URL
    - read_sheet_from_url(url)     # 读取表格数据
    - validate_feishu_url(url)     # 验证URL格式
    - _read_via_export(token, sheet_id)  # 通过导出读取（公开表格）
    - _read_via_api(token, sheet_id)     # 通过API读取（需授权）
```

### API接口

新增接口：
```
POST /api/import/shops/{shop_id}/activities/from-url
POST /api/import/shops/{shop_id}/products/from-url
```

请求示例：
```json
{
  "url": "https://mcnkufobiqbi.feishu.cn/sheets/Xd3SsrVlEhNoBXtawvlcryWVnJc?sheet=HPLHTM"
}
```

响应示例：
```json
{
  "success": true,
  "message": "活动数据导入完成",
  "data": {
    "import_id": 123,
    "status": "success",
    "total_rows": 63,
    "success_rows": 60,
    "failed_rows": 2,
    "skipped_rows": 1
  }
}
```

### 前端界面

#### 更新的组件
- **ImportDataModal.tsx**
  - 添加「导入方式」切换（Excel文件 / 在线表格）
  - 添加URL输入框和验证
  - 显示在线表格优势说明
  - 实时表单验证

#### UI设计
```
[Excel文件] [在线表格] ← 切换按钮

┌─────────────────────────────────┐
│ 在线表格链接：                    │
│ ┌─────────────────────────────┐ │
│ │ https://xxx.feishu.cn/...  │ │
│ │                             │ │
│ └─────────────────────────────┘ │
│                                   │
│ ✅ 实时同步                       │
│ 👥 团队协作                       │
│ 🔄 便捷导入                       │
│ 📝 请确保表格设置为「可访问」      │
└─────────────────────────────────┘
```

## 🔧 部署说明

### 无需额外安装

所有依赖已包含在 `requirements.txt` 中：
- `httpx==0.25.1` - 异步HTTP客户端
- `pandas==2.1.3` - 数据处理
- `pydantic==2.5.0` - 数据验证

### 部署步骤

1. **拉取最新代码**
```bash
git pull origin main
```

2. **重启服务**
```bash
# 本地环境
docker compose down
docker compose up -d --build

# 生产环境
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d --build
```

3. **验证功能**
- 访问店铺管理页面
- 点击「导入」按钮
- 应该能看到「在线表格」选项

## 📊 工作流程

```
用户操作流程：
┌──────────┐    ┌──────────┐    ┌──────────┐
│维护飞书表格│ →  │ 复制链接  │ →  │系统导入   │
└──────────┘    └──────────┘    └──────────┘

技术流程：
用户提交URL
    ↓
验证URL格式
    ↓
解析表格ID和工作表ID
    ↓
读取在线表格数据 (pandas DataFrame)
    ↓
复用现有导入逻辑
    ↓
保存到数据库
    ↓
返回导入结果
```

## 🔐 安全性说明

### 数据访问
- 仅读取公开分享的表格数据
- 不修改原始表格内容
- 不存储表格链接（仅在导入历史中记录简要信息）

### 隐私保护
- 表格链接需要用户主动分享
- 建议使用专用数据表格，不要包含敏感信息
- 可随时在飞书中取消分享权限

## 🐛 故障排查

### 问题1：无法读取表格数据

**错误信息**：`无法读取表格数据`

**可能原因**：
1. 表格未设置为公开访问
2. 链接格式不正确
3. 表格已删除或权限已变更

**解决方法**：
1. 检查飞书表格分享设置
2. 确保URL格式正确（包含 `/sheets/` 和表格ID）
3. 尝试在浏览器中直接访问链接

### 问题2：导入失败，部分数据错误

**错误信息**：`部分导入成功`

**可能原因**：
1. 表格列名与要求不一致
2. 数据格式错误（如价格、百分比）
3. 必填字段为空

**解决方法**：
1. 查看导入历史的错误日志
2. 对照要求的列名格式
3. 修正数据后重新导入

### 问题3：链接格式错误

**错误信息**：`无效的飞书表格URL`

**正确格式**：
```
https://[subdomain].feishu.cn/sheets/[spreadsheet_token]?sheet=[sheet_id]
```

**示例**：
```
https://mcnkufobiqbi.feishu.cn/sheets/Xd3SsrVlEhNoBXtawvlcryWVnJc?sheet=HPLHTM
```

## 📈 使用场景

### 场景1：团队协作数据管理
团队成员在飞书表格中协作编辑数据，运营人员定期点击导入即可同步最新数据。

### 场景2：实时数据更新
活动数据频繁变化，使用在线表格可以随时更新，无需重复下载上传。

### 场景3：数据验证和清洗
在飞书表格中使用公式和条件格式进行数据验证，确保数据质量后再导入系统。

### 场景4：多店铺数据整合
不同团队维护各自店铺的表格，系统管理员通过链接批量导入。

## 🎨 最佳实践

### 1. 表格结构规范
- 第一行必须是列名
- 列名不要修改，与Temu导出格式保持一致
- 避免合并单元格
- 避免使用复杂公式

### 2. 数据维护建议
- 定期检查数据完整性
- 使用飞书表格的数据验证功能
- 标注数据更新时间
- 保留历史数据备份

### 3. 权限管理
- 编辑权限仅授予可信任人员
- 查看权限可以设置为「知道链接的人」
- 定期审查分享链接使用情况

### 4. 导入频率
- 日常更新：每天1-2次
- 活动期间：根据需要实时导入
- 建议避免高峰期大批量导入

## 🔄 与Excel文件导入的对比

| 功能 | Excel文件 | 在线表格 |
|------|----------|---------|
| 数据来源 | 本地文件 | 飞书在线 |
| 更新方式 | 重新上传 | 粘贴链接 |
| 实时性 | ❌ | ✅ |
| 协作 | ❌ | ✅ |
| 文件大小限制 | 10MB | 无限制* |
| 网络要求 | 低 | 中 |
| 适用场景 | 一次性导入 | 频繁更新 |

*注：实际受表格平台限制

## 💡 提示

1. 首次使用建议先用Excel文件导入测试，确认数据格式正确
2. 大规模数据（>1000行）建议分批导入
3. 导入前建议在飞书表格中添加一列"导入时间"便于追踪
4. 可以在飞书表格中使用不同工作表（Sheet）管理不同时期的数据
5. 导入历史会记录所有操作，便于审计和问题排查

## 🔮 未来规划

- [ ] 支持定时自动同步
- [ ] 支持腾讯文档、石墨文档
- [ ] 支持数据预览（导入前查看前几行）
- [ ] 支持列映射配置（自定义列名对应关系）
- [ ] 支持增量更新（只导入新增/修改的数据）
- [ ] 支持双向同步（系统数据回写到表格）

