# 飞书表格密码保护功能说明

## 🔐 安全特性

系统现已支持**密码保护的飞书在线表格**，确保敏感用户数据的安全性。

## 为什么需要密码保护？

涉及用户个人信息的数据表格（如订单信息、商品详情等）通过密码保护可以：

- ✅ **防止数据泄露**：即使链接被分享，也需要密码才能访问
- ✅ **符合隐私法规**：满足GDPR、个人信息保护法等合规要求
- ✅ **权限精细控制**：只有知道密码的人才能查看数据
- ✅ **安全审计追溯**：密码访问记录可追踪

## 🛡️ 安全机制

### 1. 密码传输安全
- 密码通过HTTPS加密传输
- 后端不存储密码，仅用于本次访问
- 导入完成后密码立即丢弃

### 2. 权限验证
```
用户输入密码 → 后端验证 → 飞书服务器验证 → 返回数据
```

### 3. 失败保护
- 密码错误时明确提示
- 不会暴露表格内容
- 自动记录访问失败日志

## 📝 使用方法

### 1. 在飞书中设置密码保护

#### 步骤：
1. 打开飞书表格
2. 点击右上角「分享」按钮
3. 选择「获取链接」
4. 在权限设置中：
   - ✅ 勾选「需要密码」
   - 设置一个强密码（建议8位以上，包含字母数字）
   - 设置权限为「知道链接和密码的人可以查看」
5. 复制链接

#### 推荐密码策略：
- ✅ 长度：至少8位字符
- ✅ 复杂度：包含大小写字母、数字
- ✅ 定期更换：建议每月更换一次
- ❌ 避免：生日、电话号码等容易猜测的密码

### 2. 在系统中导入

#### 界面示例：
```
┌─────────────────────────────────────┐
│ 在线表格链接：                        │
│ ┌─────────────────────────────────┐ │
│ │ https://xxx.feishu.cn/sheets/  │ │
│ │ Xd3SsrVlEhNoBXtawvlcryWVnJc     │ │
│ └─────────────────────────────────┘ │
│                                       │
│ 🔒 访问密码（可选）：                 │
│ ┌─────────────────────────────────┐ │
│ │ ••••••••                        │ │  ← 密码输入框
│ └─────────────────────────────────┘ │
│                                       │
│ ℹ️ 安全提示                           │
│ 🔐 推荐使用密码保护表格               │
│ ✅ 实时同步                           │
│ 👥 团队协作                           │
│ 📝 密码不会被存储                     │
└─────────────────────────────────────┘
```

#### 操作步骤：
1. 进入店铺管理页面
2. 点击「导入」按钮
3. 选择「在线表格」模式
4. 粘贴飞书表格链接
5. **输入访问密码**（如果表格设置了密码）
6. 点击「开始导入」

## 🔧 技术实现

### API请求格式

```json
POST /api/import/shops/{shop_id}/activities/from-url

{
  "url": "https://mcnkufobiqbi.feishu.cn/sheets/Xd3SsrVlEhNoBXtawvlcryWVnJc?sheet=HPLHTM",
  "password": "your_secure_password"  // 可选字段
}
```

### 密码处理流程

```python
# 后端伪代码
async def read_sheet_from_url(url: str, password: Optional[str] = None):
    # 1. 解析URL
    parsed = parse_feishu_url(url)
    
    # 2. 构建请求（带密码）
    csv_url = f"{base_url}?pwd={password}" if password else base_url
    
    # 3. 请求飞书服务器
    response = await client.get(csv_url)
    
    # 4. 验证响应
    if "密码错误" in response.text:
        raise Exception("密码错误或表格需要密码访问")
    
    # 5. 返回数据
    return parse_csv(response.text)
```

### 前端安全措施

```typescript
// 使用 Input.Password 组件
<Input.Password
  value={password}
  onChange={(e) => setPassword(e.target.value)}
  placeholder="如果表格设置了密码保护，请输入密码"
  allowClear  // 支持快速清除
/>

// 导入完成后清除密码
const handleClose = () => {
  setPassword('')  // 清除内存中的密码
  // ...
}
```

## 🐛 故障排查

### 问题1：提示"密码错误"

**可能原因**：
1. 输入的密码不正确
2. 表格密码已被修改
3. 密码包含特殊字符导致编码问题

**解决方法**：
1. 检查密码是否正确（注意大小写）
2. 在飞书中重新查看/设置密码
3. 避免使用特殊符号，优先使用字母和数字

### 问题2：不输入密码也能访问

**原因**：
- 表格未正确设置密码保护
- 表格设置为「组织内可见」而非「需要密码」

**解决方法**：
1. 重新检查飞书表格的分享设置
2. 确保勾选了「需要密码」选项
3. 测试在隐身模式下访问链接是否需要密码

### 问题3：导入成功但担心密码泄露

**说明**：
- 密码仅用于本次访问
- 不会存储在数据库中
- 不会记录在日志中（已脱敏处理）
- 导入历史只记录"是否使用了密码"，不记录密码内容

**验证方法**：
```sql
-- 查看导入历史记录
SELECT file_name, created_at FROM import_history 
WHERE shop_id = 1;

-- 结果示例（不包含密码）
file_name: "飞书表格: https://xxx.feishu.cn/sheets/..."
```

## 📊 使用统计

### 导入历史记录示例

```json
{
  "id": 123,
  "file_name": "飞书表格: https://mcnku...（已截断）",
  "total_rows": 728,
  "success_rows": 720,
  "failed_rows": 8,
  "status": "success",
  "created_at": "2025-10-31T10:30:00Z"
  // 注意：不包含密码信息
}
```

## 🔒 安全最佳实践

### 1. 密码管理
- ✅ 使用密码管理器（如1Password、LastPass）存储密码
- ✅ 不同表格使用不同密码
- ✅ 定期（每月）更换密码
- ❌ 不要在聊天工具中直接发送密码

### 2. 权限控制
- ✅ 仅授权必要的人员访问
- ✅ 区分查看权限和编辑权限
- ✅ 定期审查有权限的人员名单
- ✅ 离职人员及时回收权限

### 3. 数据分类
- 🔴 高敏感：订单信息、用户联系方式 → **必须设置密码**
- 🟡 中敏感：商品价格、活动数据 → **建议设置密码**
- 🟢 低敏感：商品类目、统计汇总 → 可选设置密码

### 4. 监控审计
- 定期检查导入历史记录
- 关注异常的导入行为（如深夜导入、频繁失败）
- 保留导入日志至少90天

## 🆚 密码保护 vs 公开访问

| 特性 | 公开访问 | 密码保护 |
|------|---------|---------|
| **安全性** | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **便捷性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **合规性** | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **适用场景** | 内部测试 | 生产环境 |
| **推荐使用** | ❌ | ✅ |

## 💡 推荐配置

### 测试环境
```
权限：知道链接的人可以查看
密码：可选
数据：使用脱敏数据或假数据
```

### 生产环境
```
权限：知道链接和密码的人可以查看  ✅
密码：必须设置，且符合复杂度要求  ✅
数据：真实用户数据
定期：每月更换密码  ✅
```

## 🔮 未来增强

计划中的安全功能：
- [ ] 支持双因素认证（2FA）
- [ ] IP白名单限制
- [ ] 导入次数限制（防爆破）
- [ ] 敏感数据自动脱敏
- [ ] 审计日志详细记录
- [ ] 密码过期提醒

## ❓ 常见问题

### Q1: 密码是否会被记录？
**A**: 不会。密码仅用于本次导入，不会存储在数据库或日志中。

### Q2: 团队成员如何安全共享密码？
**A**: 建议使用企业密码管理工具（如1Password Teams）或通过加密通讯工具私密传递。

### Q3: 忘记密码怎么办？
**A**: 在飞书表格中可以查看或重新设置密码。密码由飞书管理，我们无法帮您找回。

### Q4: 是否支持其他身份验证方式？
**A**: 目前仅支持密码验证。未来计划支持飞书OAuth授权，实现更安全的免密码访问。

### Q5: 密码长度有限制吗？
**A**: 密码长度由飞书平台控制，建议8-20位字符，包含字母和数字。

## 📞 技术支持

如有任何安全疑问或发现安全问题，请：
1. 查看本文档的故障排查部分
2. 检查系统日志：`docker compose logs backend | grep -i password`
3. 联系系统管理员

---

**重要提醒**：涉及用户个人信息的数据表格，请务必使用密码保护！🔐

