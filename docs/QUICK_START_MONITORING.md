# 任务队列和监控查看 - 快速指南

## 一、通过前端界面查看

### 1.1 打开监控面板

1. 登录系统后，进入 **店铺管理** 页面
2. 点击页面右上角的 **"任务队列与监控"** 按钮
3. 如果有待处理的告警，按钮上会显示红色徽章数字

### 1.2 查看系统概览

在监控面板的 **"系统概览"** 标签页中，可以查看：

- **系统健康状态**
  - 健康分数（0-100分）
  - 系统状态（正常/降级/异常）
  - 工作线程状态（运行中/未运行）
  - 异常店铺数量

- **任务队列统计**
  - 总任务数
  - 待处理任务数
  - 处理中任务数
  - 已完成任务数
  - 失败任务数
  - 队列长度（Redis队列中的任务数）

- **监控告警**
  - 所有告警信息列表
  - 告警类型和严重程度
  - 告警详情

### 1.3 查看任务列表

在监控面板的 **"任务列表"** 标签页中，可以：

1. **选择店铺**：从下拉列表中选择要查看的店铺
2. **查看任务统计**：显示该店铺的任务统计信息
3. **查看任务详情**：显示任务列表，包括：
   - 父订单号
   - 任务状态（待处理/处理中/已完成/失败）
   - 包裹号（如果已获取）
   - 重试次数
   - 错误信息（如果失败）
   - 创建时间和完成时间

4. **手动触发补齐任务**：
   - 点击 **"创建补齐任务"** 按钮：为已发货/已签收且没有包裹号的订单创建任务（排除已取消和待发货订单）
   - 点击 **"强制重新获取"** 按钮：强制重新获取所有订单的包裹号（即使已有包裹号）

### 1.4 自动刷新

- 系统概览：每30秒自动刷新
- 任务统计：每10秒自动刷新
- 任务列表：每10秒自动刷新
- 也可以点击右上角的 **"刷新"** 按钮手动刷新

## 二、通过API查看（命令行）

### 2.1 查看任务队列统计

```bash
curl -X GET "http://localhost:8000/api/sync/orders/enrich-tasks/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2.2 查看监控告警

```bash
curl -X GET "http://localhost:8000/api/sync/monitoring/alerts" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2.3 查看系统健康状态

```bash
curl -X GET "http://localhost:8000/api/sync/monitoring/health" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2.4 查看指定店铺的任务列表

```bash
curl -X GET "http://localhost:8000/api/sync/shops/1/orders/enrich-tasks?status=pending&limit=50" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2.5 手动触发包裹号补齐

```bash
curl -X POST "http://localhost:8000/api/sync/shops/1/orders/enrich-details?force=false" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 三、告警说明

### 3.1 告警类型

| 告警类型 | 严重程度 | 说明 |
|---------|---------|------|
| queue_backlog | warning | 队列积压超过1000个任务 |
| task_failure_rate | error | 任务失败率超过10% |
| sync_error | error | 店铺同步失败 |
| sync_stale | warning | 超过24小时未同步 |
| worker_down | error | 工作线程未运行 |

### 3.2 处理建议

- **队列积压**：检查工作线程是否正常运行，或等待处理完成
- **任务失败率高**：检查API调用是否正常，查看失败任务的错误信息
- **同步错误**：检查店铺API配置，查看同步日志
- **同步过期**：检查定时任务是否正常运行
- **工作线程未运行**：重启应用

## 四、健康状态说明

### 4.1 健康分数

- **80-100分**：系统运行正常（绿色）
- **50-79分**：系统运行降级，有部分问题（黄色）
- **0-49分**：系统运行异常，需要立即处理（红色）

### 4.2 扣分规则

- 工作线程未运行：-30分
- 队列积压超过阈值：-20分
- 店铺同步错误：-20分
- 任务失败：-10分

## 五、常见问题

### Q1: 为什么队列中有很多待处理任务？

**A**: 可能的原因：
1. 工作线程未运行 - 检查健康状态中的"工作线程"状态
2. API调用速度慢 - 这是正常的，任务会逐步处理
3. 大量订单需要补齐包裹号 - 这是正常的，系统会自动处理

### Q2: 任务一直处于"处理中"状态？

**A**: 可能的原因：
1. API调用超时或失败，任务正在重试
2. 工作线程处理速度慢
3. 如果超过5分钟仍处于"处理中"，可能是任务锁未释放，可以重启应用

### Q3: 如何查看失败任务的详细信息？

**A**: 
1. 在任务列表中选择店铺
2. 筛选状态为"failed"
3. 查看"错误信息"列

### Q4: 如何重新处理失败的任务？

**A**: 
1. 点击"强制重新获取"按钮
2. 系统会为所有已发货/已签收的订单重新创建任务（包括之前失败的，排除已取消和待发货订单）

## 六、最佳实践

1. **定期查看监控告警**：建议每天查看一次
2. **关注队列长度**：如果持续增长，检查处理速度
3. **监控任务失败率**：失败率突然升高可能表示API或网络问题
4. **及时处理告警**：特别是error级别的告警，需要立即处理

