# ForgGPT 功能设计文档

## 一、功能概述

ForgGPT 是一个基于 DeepSeek API 的智能运营助手，提供以下核心功能：

1. **智能对话分析**：基于应用数据（订单、商品、店铺等）进行对话式分析和建议
2. **文件处理**：支持上传本地或在线表格/文档，进行数据分析和处理
3. **运营建议**：根据数据分析结果，提供运营优化建议
4. **数据可视化**：在对话中展示关键数据图表

## 二、技术架构

### 2.1 后端架构

```
┌─────────────────────────────────────────┐
│         ForgGPT API Layer               │
│  - /api/forggpt/chat (对话接口)         │
│  - /api/forggpt/upload (文件上传)       │
│  - /api/forggpt/analyze (数据分析)      │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      AI Conversation Service            │
│  - 对话管理                              │
│  - 上下文维护                            │
│  - Prompt构建                            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Data Analysis Service              │
│  - 数据查询与聚合                        │
│  - 统计分析                              │
│  - 数据格式化                            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      File Processing Service            │
│  - 文件解析 (Excel/CSV/JSON)            │
│  - 数据提取                              │
│  - 数据清洗                              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      DeepSeek Provider                  │
│  - API调用                               │
│  - 流式响应                              │
│  - 错误处理                              │
└─────────────────────────────────────────┘
```

### 2.2 前端架构

```
┌─────────────────────────────────────────┐
│         ForgGPT Page                    │
│  - 对话界面 (类似ChatGPT)                │
│  - 消息列表                              │
│  - 输入框                                │
│  - 文件上传区域                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Components                         │
│  - MessageList (消息列表)                │
│  - MessageItem (消息项)                  │
│  - ChatInput (输入框)                    │
│  - FileUpload (文件上传)                 │
│  - DataVisualization (数据可视化)        │
└─────────────────────────────────────────┘
```

## 三、核心功能设计

### 3.1 对话功能

#### 3.1.1 对话上下文管理

- **会话ID**：每个对话会话有唯一ID
- **消息历史**：保存对话历史（最多保留最近50条）
- **上下文窗口**：维护系统提示词 + 用户消息 + AI回复
- **数据上下文**：自动注入当前应用数据摘要

#### 3.1.2 系统提示词设计

```python
SYSTEM_PROMPT = """
你是一个专业的电商运营分析助手（ForgGPT），专门帮助分析Temu平台的运营数据。

你的能力包括：
1. 分析订单数据（GMV、订单量、利润等）
2. 分析商品数据（销量、库存、价格等）
3. 分析店铺数据（多店铺对比、区域分析等）
4. 提供运营优化建议
5. 处理上传的表格/文档数据

当前应用数据概览：
- 店铺数量：{shop_count}
- 订单总数：{order_count}
- 商品总数：{product_count}
- 最近7天GMV：{recent_gmv}
- 最近7天订单量：{recent_orders}

请用专业、简洁、易懂的方式回答用户问题，并提供可操作的建议。
"""
```

### 3.2 数据分析功能

#### 3.2.1 数据查询能力

支持查询以下数据：
- **订单数据**：GMV、订单量、利润、退款率等
- **商品数据**：销量排行、库存情况、价格分析等
- **店铺数据**：多店铺对比、区域分布等
- **时间维度**：日/周/月统计、趋势分析等

#### 3.2.2 数据格式化

将查询结果格式化为自然语言描述，便于AI理解和用户阅读。

### 3.3 文件处理功能

#### 3.3.1 支持的文件类型

- **Excel** (.xlsx, .xls)
- **CSV** (.csv)
- **JSON** (.json)
- **在线表格**：Google Sheets、腾讯文档等（通过URL）

#### 3.3.2 文件处理流程

1. **上传**：文件上传到服务器临时目录
2. **解析**：使用pandas解析文件内容
3. **分析**：提取关键信息（列名、数据类型、数据摘要）
4. **存储**：保存文件元数据和摘要（可选）
5. **清理**：处理完成后删除临时文件

#### 3.3.3 数据分析能力

- 数据摘要统计
- 异常值检测
- 数据关联分析
- 趋势预测（基于历史数据）

### 3.4 运营建议功能

基于数据分析结果，提供：
- **商品优化建议**：热销商品推荐、滞销商品处理
- **价格策略建议**：定价优化、促销建议
- **库存管理建议**：补货建议、库存优化
- **营销策略建议**：推广时机、渠道选择

## 四、API设计

### 4.1 对话接口

#### POST /api/forggpt/chat

**请求体**：
```json
{
  "message": "最近7天的销售情况如何？",
  "session_id": "optional_session_id",
  "context": {
    "shop_ids": [1, 2],
    "date_range": {
      "start": "2025-01-01",
      "end": "2025-01-07"
    }
  },
  "stream": false
}
```

**响应**：
```json
{
  "session_id": "session_123",
  "message": "根据数据分析，最近7天...",
  "data_summary": {
    "gmv": 100000,
    "orders": 500,
    "profit": 20000
  },
  "suggestions": [
    "建议关注LBB3系列商品，销量增长明显"
  ],
  "usage": {
    "prompt_tokens": 500,
    "completion_tokens": 300,
    "total_tokens": 800
  }
}
```

### 4.2 文件上传接口

#### POST /api/forggpt/upload

**请求**：multipart/form-data
- `file`: 文件
- `file_url`: 在线文件URL（可选）
- `file_type`: 文件类型（excel/csv/json）

**响应**：
```json
{
  "file_id": "file_123",
  "file_name": "sales_data.xlsx",
  "file_type": "excel",
  "summary": {
    "rows": 1000,
    "columns": 10,
    "column_names": ["date", "sales", "profit"],
    "data_types": {"date": "datetime", "sales": "float"}
  }
}
```

### 4.3 数据分析接口

#### POST /api/forggpt/analyze

**请求体**：
```json
{
  "file_id": "file_123",
  "analysis_type": "summary|trend|correlation",
  "columns": ["sales", "profit"]
}
```

**响应**：
```json
{
  "analysis": {
    "summary": {
      "total_sales": 100000,
      "avg_profit": 2000
    },
    "insights": [
      "销售额与利润呈正相关关系"
    ]
  }
}
```

## 五、前端页面设计

### 5.1 页面布局

```
┌─────────────────────────────────────────┐
│  Header: ForgGPT 智能运营助手            │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐  │
│  │  对话区域                          │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │  AI: 你好，我是ForgGPT...   │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │  用户: 最近销售情况如何？   │  │  │
│  │  └─────────────────────────────┘  │  │
│  │  ┌─────────────────────────────┐  │  │
│  │  │  AI: 根据数据分析...        │  │  │
│  │  │  [数据图表]                 │  │  │
│  │  └─────────────────────────────┘  │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  输入区域                          │  │
│  │  [文件上传] [输入框] [发送]       │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 5.2 组件设计

#### MessageList
- 显示对话消息列表
- 支持滚动到底部
- 支持消息复制、重新生成

#### MessageItem
- 用户消息：右对齐，蓝色背景
- AI消息：左对齐，灰色背景
- 支持Markdown渲染
- 支持代码高亮
- 支持数据图表展示

#### ChatInput
- 多行文本输入
- 文件上传按钮
- 发送按钮
- 快捷键支持（Enter发送，Shift+Enter换行）

#### FileUpload
- 拖拽上传
- 点击上传
- 在线URL输入
- 文件预览
- 上传进度

#### DataVisualization
- 基于ECharts/Recharts的图表组件
- 支持折线图、柱状图、饼图等
- 响应式设计

## 六、实现步骤

### 阶段一：基础对话功能
1. ✅ 完善DeepSeek Provider（支持流式响应）
2. ✅ 创建AI对话服务
3. ✅ 创建对话API端点
4. ✅ 创建前端对话页面

### 阶段二：数据集成
1. ✅ 集成StatisticsService
2. ✅ 实现数据查询与格式化
3. ✅ 优化系统提示词

### 阶段三：文件处理
1. ✅ 实现文件上传功能
2. ✅ 实现文件解析（Excel/CSV/JSON）
3. ✅ 实现数据分析功能

### 阶段四：优化与增强
1. ✅ 添加数据可视化
2. ✅ 优化对话体验
3. ✅ 添加对话历史保存
4. ✅ 性能优化

## 七、技术栈

### 后端
- FastAPI
- DeepSeek API
- pandas（数据处理）
- openpyxl（Excel处理）

### 前端
- React + TypeScript
- Ant Design
- React Query（数据获取）
- ECharts/Recharts（数据可视化）
- Markdown渲染库

## 八、注意事项

1. **API限流**：DeepSeek API有调用频率限制，需要实现限流和重试机制
2. **Token限制**：注意上下文窗口大小，避免超出限制
3. **数据安全**：上传的文件需要及时清理，避免泄露
4. **性能优化**：大数据量查询需要优化，考虑使用缓存
5. **错误处理**：完善的错误处理和用户提示


