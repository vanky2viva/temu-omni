# 数据同步策略说明

## 📋 同步策略概述

系统支持两种同步模式：

1. **全量同步**：同步所有数据（用于初始导入）
2. **增量同步**：只同步新增和更新的数据（用于定期同步）

## 🔄 同步模式说明

### 订单同步

#### 全量同步 (`full_sync=True`)
- **使用场景**：首次导入数据或需要重新同步所有历史订单
- **时间范围**：从1年前开始同步到当前时间
- **特点**：数据完整，但耗时较长

#### 增量同步 (`full_sync=False`) - **推荐用于定时任务**
- **使用场景**：定期自动同步新订单
- **时间范围**：
  - 如果店铺有 `last_sync_at` 记录：从最后同步时间开始
  - 如果从未同步：从7天前开始
- **特点**：快速高效，只同步新数据

### 商品同步

#### 全量同步 (`full_sync=True`)
- **使用场景**：首次导入或需要重新同步所有商品
- **同步范围**：同步所有商品（包括在售和不在售）
- **特点**：数据完整，但耗时较长

#### 增量同步 (`full_sync=False`) - **推荐用于定时任务**
- **使用场景**：定期自动同步商品更新
- **同步范围**：只同步新增和更新的商品（通过商品ID判断）
- **特点**：快速高效，只同步变化的数据

## ⏰ 定时任务配置

### 自动同步配置

在 `.env` 文件中配置：

```env
# 是否启用自动同步
AUTO_SYNC_ENABLED=True

# 订单同步间隔（分钟）
SYNC_INTERVAL_MINUTES=30
```

### 定时任务列表

| 任务名称 | 执行频率 | 同步模式 | 说明 |
|---------|---------|---------|------|
| 更新订单成本 | 每30分钟 | - | 计算订单成本和利润 |
| 同步订单数据 | 每30分钟（可配置） | 增量同步 | 同步新订单和订单状态更新 |
| 同步商品数据 | 每60分钟 | 增量同步 | 同步商品信息更新 |

### 任务执行逻辑

1. **订单同步任务**：
   - 遍历所有启用的店铺
   - 对每个店铺执行增量同步
   - 从最后同步时间开始，获取新订单和订单状态更新
   - 更新店铺的 `last_sync_at` 时间

2. **商品同步任务**：
   - 遍历所有启用的店铺
   - 对每个店铺执行增量同步
   - 只同步新增和更新的商品（通过商品ID判断）

3. **订单成本计算任务**：
   - 计算没有成本的订单的成本和利润
   - 同时更新订单金额（如果商品有供货价格）

## 🚀 使用建议

### 初始设置（全量同步）

首次使用时，建议手动执行全量同步：

```bash
# 通过API手动触发全量同步
POST /api/sync/shops/{shop_id}/orders?full_sync=true
POST /api/sync/shops/{shop_id}/products?full_sync=true
```

或使用脚本：

```bash
cd backend
python scripts/resync_all_shops.py --full-sync
```

### 日常运行（增量同步）

配置好定时任务后，系统会自动执行增量同步：

1. **订单同步**：每30分钟自动同步新订单
2. **商品同步**：每60分钟自动同步商品更新
3. **成本计算**：每30分钟自动计算订单成本

## 📊 同步策略对比

| 特性 | 全量同步 | 增量同步 |
|-----|---------|---------|
| **使用场景** | 初始导入 | 定期同步 |
| **同步范围** | 所有数据 | 新增和更新 |
| **执行时间** | 较长 | 较短 |
| **API调用** | 较多 | 较少 |
| **数据完整性** | 完整 | 依赖历史记录 |
| **推荐频率** | 手动触发 | 自动定时 |

## 🔍 同步状态检查

### 查看同步日志

```bash
# 查看应用日志
docker logs temu-omni-backend | grep "同步"

# 或查看日志文件
tail -f logs/app.log | grep "同步"
```

### 检查店铺同步时间

```sql
-- 查看各店铺的最后同步时间
SELECT id, shop_name, last_sync_at, is_active 
FROM shops 
WHERE is_active = true;
```

### 通过API检查定时任务状态

```bash
GET /api/system/scheduler/status
```

## ⚙️ 配置说明

### 环境变量配置

```env
# 自动同步开关
AUTO_SYNC_ENABLED=True

# 订单同步间隔（分钟）
SYNC_INTERVAL_MINUTES=30

# 时区设置
TIMEZONE=Asia/Shanghai
```

### 调整同步频率

如果需要调整同步频率，可以修改：

1. **订单同步频率**：修改 `SYNC_INTERVAL_MINUTES` 环境变量
2. **商品同步频率**：修改 `backend/app/core/scheduler.py` 中的商品同步任务配置

## 🛠️ 故障排查

### 问题1：同步任务未执行

**检查项**：
1. 确认 `AUTO_SYNC_ENABLED=True`
2. 检查调度器是否启动（查看应用启动日志）
3. 通过API检查调度器状态

### 问题2：同步数据不完整

**解决方案**：
1. 手动执行一次全量同步
2. 检查店铺的 `last_sync_at` 时间是否正确
3. 查看同步日志了解详细错误

### 问题3：同步任务执行失败

**检查项**：
1. 检查店铺Token是否有效
2. 检查网络连接和代理配置
3. 查看详细错误日志

## 📝 最佳实践

1. **初始设置**：
   - 首次使用时执行全量同步
   - 确保所有历史数据都已导入

2. **日常运行**：
   - 启用自动同步（增量模式）
   - 定期检查同步日志
   - 监控同步任务执行状态

3. **数据维护**：
   - 定期（如每周）执行一次全量同步，确保数据完整性
   - 检查并修复同步失败的数据
   - 监控API调用频率，避免超出限制

4. **性能优化**：
   - 根据实际需求调整同步频率
   - 对于大量店铺，考虑错开同步时间
   - 监控数据库性能，必要时优化查询

