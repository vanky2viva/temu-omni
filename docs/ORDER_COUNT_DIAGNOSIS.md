# 订单统计差异诊断报告

## 问题描述

**echofrog 店铺 2025-11-27 的订单统计差异：**
- 平台显示：101 个有效订单（待发货）
- 系统统计：86 个父订单（PROCESSING 状态）
- **差异：15 个订单**

## 诊断结果

### 1. 订单数据统计

**11-27 当天的订单：**
- 总订单记录数：99 条
- PROCESSING 订单记录数：89 条
- PROCESSING 父订单数：86 个
- CANCELLED 订单：10 条

**扩大日期范围（11-26 ~ 11-28）：**
- PROCESSING 父订单数：246 个
- 所有时间的 PROCESSING 父订单数：1020 个

### 2. 订单时间分布

```
2025-11-26: 95 个父订单
2025-11-27: 86 个父订单
2025-11-28: 65 个父订单
```

### 3. 可能原因分析

#### 原因 1：订单同步不完整（最可能）

**症状：**
- 系统只有 86 个父订单，平台有 101 个
- 差异：15 个订单

**可能原因：**
- 订单同步时，某些订单没有被成功同步
- 订单同步的时间范围不够（可能只同步了部分订单）
- 订单同步过程中出现错误，导致部分订单丢失

**解决方案：**
1. **重新同步订单**：在订单列表页面，选择 echofrog 店铺，点击"同步订单"
2. **扩大同步时间范围**：确保同步包含 11-27 前后的订单
3. **检查同步日志**：查看是否有同步错误或失败的订单

#### 原因 2：日期范围判断问题

**症状：**
- 扩大日期范围后找到 246 个订单
- 说明订单是存在的，但可能日期判断有问题

**可能原因：**
- 平台使用的日期字段与系统不同（如：创建时间 vs 下单时间）
- 时区转换问题导致某些订单被归类到错误的日期

**解决方案：**
- 检查订单的 `order_time` 字段是否正确
- 确认时区处理逻辑是否正确

#### 原因 3：订单状态映射问题

**症状：**
- 系统只统计 PROCESSING 状态的订单
- 平台可能包含其他状态的订单

**可能原因：**
- 平台的有效订单定义与系统不同
- 某些订单的状态映射不正确

**解决方案：**
- 确认平台的有效订单定义
- 检查订单状态映射逻辑

## 建议的修复步骤

### 步骤 1：重新同步订单（推荐）

1. 登录系统
2. 进入"订单列表"页面
3. 选择 echofrog 店铺
4. 设置日期范围为 2025-11-26 ~ 2025-11-28（扩大范围确保包含所有订单）
5. 点击"同步订单"按钮
6. 等待同步完成
7. 重新检查统计结果

### 步骤 2：验证同步结果

运行诊断脚本验证：
```bash
cd /Users/vanky/code/temu-Omni/backend
python3 scripts/check_echofrog_orders.py
```

### 步骤 3：如果仍有差异

1. **检查订单同步日志**：查看是否有同步错误
2. **检查订单状态**：确认所有订单的状态是否正确
3. **检查日期字段**：确认订单的 `order_time` 是否正确
4. **联系技术支持**：如果问题持续存在，可能需要进一步调查

## 当前统计逻辑

### 有效订单定义

系统统计的有效订单包括：
- `PROCESSING`（待发货）
- `SHIPPED`（已发货）
- `DELIVERED`（已签收）

### 订单数统计口径

- **父订单去重**：如果 `parent_order_sn` 存在，使用 `parent_order_sn`；否则使用 `order_sn`
- **日期范围**：根据 `order_time` 字段（北京时间）进行筛选
- **店铺筛选**：根据 `shop_id` 进行筛选

### 日期范围处理

- 使用北京时间（UTC+8）进行日期判断
- `order_time` 字段存储为 naive datetime（表示北京时间）
- 日期提取使用 `func.date(Order.order_time)`

## 相关文件

- `backend/app/api/analytics.py` - 统计 API
- `backend/app/services/unified_statistics.py` - 统一统计服务
- `backend/app/services/sync_service.py` - 订单同步服务
- `backend/scripts/check_echofrog_orders.py` - 诊断脚本











